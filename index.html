<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Viaggio a Londra ‚Äì Programma + Nightlife Planner (Versione Definitiva e Funzionante)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  
  <style>
    /* Layout Generale */
    body {
      margin: 0;
      font-family: Arial, Helvetica, sans-serif;
      display: grid;
      grid-template-columns: 480px 1fr; 
      height: 100vh;
      overflow: hidden;
    }
    #sidebar {
      overflow-y: auto;
      padding: 16px;
      background: #f7f7f7;
      border-right: 1px solid #ddd;
    }
    #map {
      height: 100%;
    }
    
    /* Stili Sidebar */
    h2 { margin-top: 0; padding-bottom: 5px; }
    h3 { color: #0056b3; }
    
    /* Stili Tappe Giornaliere */
    .day { border-left: 5px solid; padding-left: 10px; margin-bottom: 25px; }
    .day-Venerdi { border-left-color: #0056b3; } 
    .day-Sabato { border-left-color: #e65100; } 
    .day-Domenica { border-left-color: #2e7d32; } 
    .day-Lunedi { border-left-color: #6a1b9a; } 
    .stop { font-size: 0.9rem; margin-bottom: 8px; padding: 5px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s; display: flex; gap: 10px; align-items: flex-start;}
    .stop:hover { background-color: #e0e0e0; }
    .num { font-weight: bold; width: 15px; text-align: right; }
    .details { flex-grow: 1; }
    .transport { font-size: 0.8rem; color: #555; font-style: italic; }
    
    /* Stili Logica Meteo */
    .rain-option { display: none; color: #c0392b; font-weight: bold;}
    #weather-selector button { border: 1px solid #0056b3; }
    #weather-selector button.active { background-color: #0056b3; color: white; }
    
    /* Logistica Notturna */
    #nightlife-planner { margin-top: 20px; padding: 10px; background: #fff; border-radius: 5px; }
    #nightlife-planner h4 { color: #8e44ad; margin-top: 0; border-bottom: 1px solid #ccc; padding-bottom: 5px; }
    #nightlife-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
    #nightlife-table th, #nightlife-table td { border: 1px solid #eee; padding: 6px; text-align: left; }
    #nightlife-table th { background-color: #f0f0f0; }
    
    /* Stili per le icone Leaflet personalizzate (Necessario per Font Awesome) */
    .custom-icon {
        background-color: transparent !important;
        border: none !important;
    }
    .icon-club { color: #8e44ad; font-size: 20px; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); } /* Viola */
    .icon-bar { color: #e67e22; font-size: 20px; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); } /* Arancione */
    .icon-hotel { color: #34495e; font-size: 20px; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); } /* Grigio scuro */
    .icon-tree { color: #2e7d32; font-size: 20px; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); } /* Verde scuro */
    
    .leaflet-control-layers-base label { font-weight: bold; }
  </style>
</head>
<body>
  <div id="sidebar">
    <h2>üá¨üáß Londra: Itinerario Definitivo</h2>
    
    <div id="weather-selector">
        <p>Seleziona l'opzione in base al meteo previsto:</p>
        <button id="btn-sole" class="active">‚òÄÔ∏è Sole / Tempo Bello</button>
        <button id="btn-pioggia">üåßÔ∏è Pioggia / Freddo</button>
    </div>

    <div class="day day-Venerdi" data-day="Venerd√¨">
      <h3>Venerd√¨ 19: Arrivo & City of London</h3>
      <div class="stop" data-coords="51.5246, -0.0797"><span class="num">1.</span><div class="details"><span class="time">16:00</span> ‚Äì Check-in ibis Shoreditch <span class="transport">(Metro/Piedi)</span></div></div>
      <div class="stop" data-coords="51.5235, -0.0740"><span class="num">2.</span><div class="details">Passeggiata: Brick Lane & Street Art <span class="transport">(A Piedi)</span><span class="rain-option">‚òî Alternativa Pioggia: Whitechapel Gallery.</span></div></div>
      <div class="stop" data-coords="51.5132, -0.0827"><span class="num">3.</span><div class="details">Visita a <span class="highlight">Leadenhall Market</span> <span class="transport">(A Piedi/Metro)</span></div></div>
      <div class="stop" data-coords="51.5115, -0.0837"><span class="num">4.</span><div class="details"><span class="time">19:00</span> ‚Äì <span class="highlight">Sky Garden</span> (Tramonto) <span class="transport">(A Piedi)</span></div></div>
    </div>

    <div class="day day-Sabato" data-day="Sabato">
      <h3>Sabato 20: Storia Reale & Centro</h3>
      <div class="stop" data-coords="51.5081, -0.0759"><span class="num">1.</span><div class="details"><span class="time">09:30</span> ‚Äì <span class="highlight">Tower of London</span> & <span class="highlight">Tower Bridge</span> <span class="transport">(Metro)</span></div></div>
      <div class="stop" data-coords="51.5138, -0.0984"><span class="num">2.</span><div class="details">Cattedrale di St Paul & Millennium Bridge <span class="transport">(A Piedi)</span></div></div>
      <div class="stop" data-coords="51.5007, -0.1246"><span class="num">3.</span><div class="details"><span class="highlight">Big Ben</span> & Parlamento <span class="transport">(Metro)</span></div></div>
      <div class="stop" data-coords="51.5034, -0.1384"><span class="num">4.</span><div class="details"><span class="highlight">Buckingham Palace</span> & St James's Park <span class="transport">(A Piedi)</span><span class="rain-option">‚òî Alternativa Pioggia: National Gallery.</span></div></div>
      <div class="stop" data-coords="51.5134, -0.1232"><span class="num">5.</span><div class="details">Shopping: <span class="highlight">Check It Vintage</span> & <span class="highlight">Goodwin's Court</span> <span class="transport">(A Piedi)</span></div></div>
      <div class="stop" data-coords="51.5101, -0.1360"><span class="num">6.</span><div class="details">Piccadilly Circus & Chinatown <span class="transport">(A Piedi)</span></div></div>
      <div class="stop" data-coords="51.5109, -0.1331" data-special="tree"><span class="num">7.</span><div class="details">Pub <span class="highlight">Waxy O‚ÄôConnor‚Äôs</span> (Albero) <span class="transport">(A Piedi)</span></div></div>
    </div>

    <div class="day day-Domenica" data-day="Domenica">
      <h3>Domenica 21: Nord, Musei & Mercati</h3>
      <div class="stop" data-coords="51.5317, -0.1245"><span class="num">1.</span><div class="details">Stazione King's Cross & <span class="highlight">St Pancras Hotel</span> <span class="transport">(Metro)</span></div></div>
      <div class="stop" data-coords="51.4967, -0.1764"><span class="num">2.</span><div class="details"><span class="time">11:00</span> ‚Äì <span class="highlight">Natural History Museum</span> <span class="transport">(Metro)</span></div></div>
      <div class="stop" data-coords="51.4994, -0.1633"><span class="num">3.</span><div class="details"><span class="highlight">Harrods</span> & Pranzo <span class="transport">(A Piedi)</span></div></div>
      <div class="stop" data-coords="51.5086, -0.1638"><span class="num">4.</span><div class="details">Passeggiata: <span class="highlight">Hyde Park</span> <span class="transport">(A Piedi)</span><span class="rain-option">‚òî Alternativa Pioggia: Victoria & Albert Museum.</span></div></div>
      <div class="stop" data-coords="51.5376, -0.1427"><span class="num">5.</span><div class="details"><span class="highlight">Camden Town</span> & <span class="highlight">Mercato</span> <span class="transport">(Metro)</span></div></div>
    </div>
    
    <div class="day day-Lunedi" data-day="Luned√¨">
      <h3>Luned√¨ 22: Partenza</h3>
      <div class="stop"><span class="num">1.</span><div class="details"><span class="time">10:00</span> ‚Äì Check-out</div></div>
      <div class="stop" data-coords="51.5179, -0.0811"><span class="num">2.</span><div class="details"><span class="time">11:30</span> ‚Äì Stansted Express (Liverpool St.)</div></div>
      <div class="stop"><span class="num">3.</span><div class="details"><span class="time">15:00</span> ‚Äì Volo di ritorno</div></div>
    </div>
    
    <div id="nightlife-planner">
        <h4><i class="fa-solid fa-moon"></i> Logistica Vita Notturna (Partenza: ibis Shoreditch)</h4>
        <table id="nightlife-table">
            <thead>
                <tr>
                    <th>Nome / Tipo</th>
                    <th>Zona</th>
                    <th>Tempo stimato (Metro/Piedi)</th>
                    <th>Caratteristiche</th>
                </tr>
            </thead>
            <tbody>
                <tr><td colspan="4" style="background-color: #f3e5f5; font-weight: bold;">üü£ CLUB & Grandi Locali (Musica Elettronica, Dance)</td></tr>
                <tr><td>XOYO</td><td>Shoreditch</td><td>10 min (Piedi)</td><td>Elettronica/Dance, Ottimo per Venerd√¨.</td></tr>
                <tr><td>Cargo</td><td>Shoreditch</td><td>15 min (Piedi)</td><td>Club grande con giardino, molto vicino.</td></tr>
                <tr><td>KOKO</td><td>Camden</td><td>20 min (Metro)</td><td>Musica dal vivo/Club night, perfetto per Domenica.</td></tr>
                <tr><td>Ministry of Sound</td><td>Elephant & Castle</td><td>30 min (Metro)</td><td>Famoso (Sud Londra), richiede viaggio.</td></tr>
                <tr><td>Phonox</td><td>Brixton</td><td>40 min (Metro)</td><td>Musica elettronica di alta qualit√† (Sud Londra).</td></tr>
                <tr><td>Electric Brixton</td><td>Brixton</td><td>40 min (Metro)</td><td>Ottimo per eventi, richiede lungo viaggio.</td></tr>
                <tr><td>Tape / Cirque Le Soir / Tabu</td><td>Mayfair</td><td>25 min (Uber/Taxi)</td><td>Molto esclusivi, costosi, dress code rigido.</td></tr>
                <tr><td colspan="4" style="background-color: #fff3e0; font-weight: bold;">üç∏ Speakeasy & Cocktail Bar (Ideali per Sabato)</td></tr>
                <tr><td>Cahoots Underground</td><td>Soho</td><td>20 min (Metro)</td><td>Speakeasy a tema Metro (Prenotazione!).</td></tr>
                <tr><td>Cahoots Postal Office</td><td>Soho</td><td>20 min (Metro)</td><td>Alternativa a Cahoots Underground.</td></tr>
                <tr><td>Fitz\'s Bar</td><td>Bloomsbury</td><td>15 min (Metro)</td><td>Bar elegante e di lusso in un hotel.</td></tr>
            </tbody>
        </table>
    </div>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // --- Configurazione Mappa e Icone ---
    
    // Inizializzazione della Mappa
    const map = L.map('map').setView([51.515, -0.12], 12); 

    // CORREZIONE DEFINITIVA: Forziamo l'uso di HTTPS per la sicurezza del browser
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);

    // Definizione dei gruppi di layer (per il pannello di controllo)
    const touristMarkers = L.featureGroup();
    const clubMarkers = L.featureGroup();
    const barMarkers = L.featureGroup();
    
    // Icone Font Awesome personalizzate
    const createFAIcon = (className, iconHtml) => L.divIcon({
        className: 'custom-icon ' + className,
        html: `<div style="text-align: center;"><i class="${iconHtml}"></i></div>`,
        iconSize: [30, 30],
        iconAnchor: [15, 30],
        popupAnchor: [0, -20]
    });
    
    const clubIcon = createFAIcon('icon-club', 'fa-solid fa-volume-high');
    const barIcon = createFAIcon('icon-bar', 'fa-solid fa-martini-glass');
    const hotelIcon = createFAIcon('icon-hotel', 'fa-solid fa-bed');
    const treeIcon = createFAIcon('icon-tree', 'fa-solid fa-tree'); // Waxy O'Connor's

    // Icona per l'itinerario giornaliero (un semplice cerchio colorato)
    const createDailyIcon = (color) => L.divIcon({
        className: 'custom-div-icon',
        html: `<div style="background-color: ${color}; border-radius: 50%; width: 10px; height: 10px; border: 2px solid white;"></div>`,
        iconSize: [20, 20],
        iconAnchor: [10, 10]
    });

    // Colori per i giorni
    const colors = {
      'Venerd√¨': '#0056b3',
      'Sabato': '#e65100',
      'Domenica': '#2e7d32',
      'Luned√¨': '#6a1b9a'
    };

    // --- Dati Turistici (Itinerario Giornaliero) ---
    const stops = [
      { name: 'ibis Shoreditch (Hotel)', coords: [51.5246, -0.0797], day: 'Venerd√¨', color: colors['Venerd√¨'], specialIcon: hotelIcon, group: touristMarkers },
      { name: 'Brick Lane & Street Art', coords: [51.5235, -0.0740], day: 'Venerd√¨', color: colors['Venerd√¨'], group: touristMarkers },
      { name: 'Leadenhall Market', coords: [51.5132, -0.0827], day: 'Venerd√¨', color: colors['Venerd√¨'], group: touristMarkers },
      { name: 'Sky Garden (Tramonto)', coords: [51.5115, -0.0837], day: 'Venerd√¨', color: colors['Venerd√¨'], group: touristMarkers },
      { name: 'Tower of London & Tower Bridge', coords: [51.5081, -0.0759], day: 'Sabato', color: colors['Sabato'], group: touristMarkers },
      { name: 'Cattedrale di St Paul', coords: [51.5138, -0.0984], day: 'Sabato', color: colors['Sabato'], group: touristMarkers },
      { name: 'Big Ben & Parlamento', coords: [51.5007, -0.1246], day: 'Sabato', color: colors['Sabato'], group: touristMarkers },
      { name: 'Buckingham Palace & St James\'s Park', coords: [51.5034, -0.1384], day: 'Sabato', color: colors['Sabato'], group: touristMarkers },
      { name: 'Check It Vintage & Goodwin\'s Court', coords: [51.5134, -0.1232], day: 'Sabato', color: colors['Sabato'], group: touristMarkers },
      { name: 'Piccadilly Circus & Chinatown', coords: [51.5101, -0.1360], day: 'Sabato', color: colors['Sabato'], group: touristMarkers },
      { name: 'Waxy O‚ÄôConnor‚Äôs Pub (Albero)', coords: [51.5109, -0.1331], day: 'Sabato', color: colors['Sabato'], specialIcon: treeIcon, group: touristMarkers },
      { name: 'St Pancras Renaissance Hotel', coords: [51.5317, -0.1245], day: 'Domenica', color: colors['Domenica'], group: touristMarkers },
      { name: 'Natural History Museum', coords: [51.4967, -0.1764], day: 'Domenica', color: colors['Domenica'], group: touristMarkers },
      { name: 'Harrods (Shopping)', coords:
